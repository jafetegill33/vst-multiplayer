<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viking Settlement Tycoon</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "nipplejs": "https://esm.sh/nipplejs"
        }
    }
    </script>
    <script>
        // Enhanced Socket.IO loading with CDN fallback
        let socketIOAttempts = 0;
        const maxSocketIOAttempts = 3;
        
        async function initializeGame() {
            socketIOAttempts++;
            
            try {
                // Check if Socket.IO is already loaded from CDN
                if (typeof io !== 'undefined') {
                    console.log('Socket.IO loaded from CDN');
                    loadGameScript();
                    return;
                }
                
                throw new Error('Socket.IO not available');
            } catch (error) {
                console.error('Socket.IO initialization failed:', error.message);
                
                if (socketIOAttempts < maxSocketIOAttempts) {
                    console.log(`Retrying Socket.IO load (${socketIOAttempts}/${maxSocketIOAttempts})...`);
                    setTimeout(initializeGame, 2000);
                } else {
                    showLoadingError();
                }
            }
        }
        
        function loadGameScript() {
            const gameScript = document.createElement('script');
            gameScript.src = 'game.js';
            gameScript.onload = function() {
                console.log('Game script loaded successfully');
                hideLoadingIndicator();
            };
            gameScript.onerror = function() {
                console.error('Failed to load game script');
                showLoadingError('Failed to load game script');
            };
            document.body.appendChild(gameScript);
        }
        
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: rgba(44, 24, 16, 0.95); color: #d4af37; padding: 30px; 
                            border-radius: 15px; text-align: center; z-index: 9999; border: 2px solid #8b4513;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.7);">
                    <div style="font-size: 2rem; margin-bottom: 15px;">‚ö°</div>
                    <h3 style="margin: 0 0 10px 0; font-family: 'Space Mono', monospace;">Loading Viking Settlement Tycoon</h3>
                    <p style="margin: 0; font-size: 0.9rem; color: #cccccc;">Connecting to multiplayer server...</p>
                    <div style="margin-top: 15px; width: 200px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px; overflow: hidden;">
                        <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #d4af37 0%, #f4c842 100%); 
                                    animation: loading 1.5s ease-in-out infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes loading {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }
        
        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        function showLoadingError(customMessage = null) {
            hideLoadingIndicator();
            
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                            background: rgba(244, 67, 54, 0.95); color: white; padding: 30px; 
                            border-radius: 15px; text-align: center; z-index: 9999; border: 2px solid #d32f2f;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.7);">
                    <div style="font-size: 2rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h3 style="margin: 0 0 10px 0; font-family: 'Space Mono', monospace;">Connection Error</h3>
                    <p style="margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.4;">
                        ${customMessage || 'Unable to connect to the multiplayer server. This could be due to:'}<br>
                        ‚Ä¢ Server is offline or unreachable<br>
                        ‚Ä¢ Network connectivity issues<br>
                        ‚Ä¢ Firewall or proxy blocking the connection
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="window.location.reload()" 
                                style="padding: 12px 24px; background: white; color: #f44336; 
                                       border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
                                       font-family: 'Space Mono', monospace;">
                            üîÑ Retry
                        </button>
                        <button onclick="showOfflineMode()" 
                                style="padding: 12px 24px; background: transparent; color: white; 
                                       border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: bold;
                                       font-family: 'Space Mono', monospace;">
                            üì± Play Offline
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(errorDiv);
        }
        
        function showOfflineMode() {
            alert('Offline mode is not available in this multiplayer version. Please check your connection and try again.');
        }
        
        // Start initialization when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                showLoadingIndicator();
                initializeGame();
            });
        } else {
            showLoadingIndicator();
            initializeGame();
        }
    </script>
</head>
<body>
    <div id="gameContainer">
        <!-- Top UI Bar -->
        <div id="topUI">
            <div class="ui-section">
                <h1 class="game-title">Viking Settlement Tycoon</h1>
            </div>
            <div class="ui-section">
                <div class="resources">
                    <div class="resource-item">
                        <span class="resource-icon">üåæ</span>
                        <div class="resource-info">
                            <span class="resource-value" id="food">100</span>
                            <span class="resource-rate">(0/ps)</span>
                        </div>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">ü™µ</span>
                        <div class="resource-info">
                            <span class="resource-value" id="wood">50</span>
                            <span class="resource-rate">(0/ps)</span>
                        </div>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">‚öíÔ∏è</span>
                        <div class="resource-info">
                            <span class="resource-value" id="iron">25</span>
                            <span class="resource-rate">(0/ps)</span>
                        </div>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">üè∫</span>
                        <div class="resource-info">
                            <span class="resource-value" id="gold">10</span>
                            <span class="resource-rate">(0/ps)</span>
                        </div>
                    </div>
                    <div class="resource-item">
                        <span class="resource-icon">üë•</span>
                        <div class="resource-info">
                            <span class="resource-value" id="population">5</span>
                            <span class="resource-rate">(+0/ps)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div id="gameWorld">
            <canvas id="gameCanvas"></canvas>
            
            <!-- Building Selection Panel -->
            <div id="buildingPanel" class="panel">
                <h3>Construct Buildings</h3>
                <div class="building-grid">
                    <div class="building-card" data-building="longhouse">
                        <div class="building-icon">üèòÔ∏è</div>
                        <div class="building-name">Longhouse</div>
                        <div class="building-cost">ü™µ 20 üåæ 10</div>
                    </div>
                    <div class="building-card" data-building="farm">
                        <div class="building-icon">üåæ</div>
                        <div class="building-name">Farm</div>
                        <div class="building-cost">ü™µ 15</div>
                    </div>
                    <div class="building-card" data-building="lumbermill">
                        <div class="building-icon">ü™ì</div>
                        <div class="building-name">Lumber Mill</div>
                        <div class="building-cost">ü™µ 25 ‚öíÔ∏è 5</div>
                    </div>
                    <div class="building-card" data-building="blacksmith">
                        <div class="building-icon">‚öíÔ∏è</div>
                        <div class="building-name">Blacksmith</div>
                        <div class="building-cost">ü™µ 30 ‚öíÔ∏è 10</div>
                    </div>
                    <div class="building-card" data-building="tradingpost">
                        <div class="building-icon">‚õµ</div>
                        <div class="building-name">Trading Post</div>
                        <div class="building-cost">ü™µ 40 üè∫ 5</div>
                    </div>
                    <div class="building-card" data-building="temple">
                        <div class="building-icon">‚ö°</div>
                        <div class="building-name">Temple</div>
                        <div class="building-cost">ü™µ 50 ‚öíÔ∏è 20 üè∫ 15</div>
                    </div>
                </div>
            </div>

            <!-- Settlement Info Panel -->
            <div id="infoPanel" class="panel">
                <h3>Settlement Status</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <span class="stat-label">Happiness:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="happinessBar" style="width: 75%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Defense:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="defenseBar" style="width: 40%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Prosperity:</span>
                        <div class="stat-bar">
                            <div class="stat-fill" id="prosperityBar" style="width: 60%"></div>
                        </div>
                    </div>
                </div>
                <div class="settlement-actions">
                    <button id="generateMapBtn" class="action-btn">üó∫Ô∏è New Territory</button>
                    <button id="saveGameBtn" class="action-btn">üíæ Save</button>
                </div>
            </div>
        </div>

        <!-- Notification System -->
        <div id="notifications"></div>
    </div>
</body>
</html>